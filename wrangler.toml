name = "iofold-validation"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# NOTE: Run `npx wrangler d1 create iofold_validation` to create the database
# Then replace the database_id below with the actual ID from the output
[[d1_databases]]
binding = "DB"
database_name = "iofold_validation"
database_id = "REPLACE_WITH_ACTUAL_DATABASE_ID"

# Cloudflare Sandbox for Python code execution
[[env.production.services]]
binding = "Sandbox"
service = "cloudflare/sandbox"

# For local development, you'll need to configure a local sandbox
# or mock the sandbox binding in tests
[[env.development.services]]
binding = "Sandbox"
service = "cloudflare/sandbox"

# ============================================================================
# Cloudflare Queues for Background Job Processing
# ============================================================================

# Main job queue - producer binding
[[queues.producers]]
binding = "JOB_QUEUE"
queue = "iofold-jobs"

# Main job queue - consumer configuration
[[queues.consumers]]
queue = "iofold-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "iofold-jobs-dlq"

# Dead letter queue - for failed jobs after max retries
[[queues.producers]]
binding = "DEAD_LETTER_QUEUE"
queue = "iofold-jobs-dlq"

# ============================================================================
# Scheduled Tasks (Cron Triggers)
# ============================================================================

# Monitoring job runs every 6 hours to check eval performance
[triggers]
crons = ["0 */6 * * *"]

[vars]
ENVIRONMENT = "development"
