name = "iofold-validation"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# Workers Observability - enables console.log capture in dashboard
[observability]
enabled = true

[observability.logs]
enabled = true
invocation_logs = true

# ============================================================================
# Staging Environment
# ============================================================================
[env.staging]
name = "iofold-staging"
routes = [
  { pattern = "api.staging.iofold.com", custom_domain = true }
]

[env.staging.vars]
ENVIRONMENT = "staging"
LANGFUSE_BASE_URL = "https://cloud.langfuse.com"
# Cloudflare AI Gateway configuration
# Create gateway at: https://dash.cloudflare.com/?to=/:account/ai/ai-gateway
CF_AI_GATEWAY_ID = "iofold-ai-gw"
CF_ACCOUNT_ID = "b26e4af8b7631a2c8d99476fd7bce974"
# LangSmith Tracing (set LANGSMITH_API_KEY in secrets)
LANGSMITH_TRACING_V2 = "true"
LANGSMITH_PROJECT = "iofold-staging"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "iofold-staging-db"
database_id = "9eaff631-3152-432f-9d07-20de2ed8857f"

[[env.staging.d1_databases]]
binding = "BENCHMARKS_DB"
database_name = "iofold-benchmarks"
database_id = "e5357be6-fc4e-43ad-9b14-3a05189ed9f9"

[[env.staging.queues.producers]]
binding = "JOB_QUEUE"
queue = "iofold-jobs"

[[env.staging.queues.consumers]]
queue = "iofold-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "iofold-jobs-dlq"

[[env.staging.queues.producers]]
binding = "DEAD_LETTER_QUEUE"
queue = "iofold-jobs-dlq"

[[env.staging.vectorize]]
binding = "VECTORIZE"
index_name = "system-prompts"

[env.staging.ai]
binding = "AI"

[env.staging.triggers]
crons = ["0 */6 * * *"]

# Sandbox Container for Python eval execution
[[env.staging.containers]]
class_name = "PythonSandbox"
image = "./Dockerfile"
instance_type = "lite"
max_instances = 5

[[env.staging.durable_objects.bindings]]
name = "SANDBOX"
class_name = "PythonSandbox"

# ============================================================================
# Local Development (default)
# ============================================================================

# Disable containers in local dev (Docker not required)
[dev]
enable_containers = false
ip = "0.0.0.0"
port = 8787
local_protocol = "http"

[vars]
ENVIRONMENT = "development"
LANGFUSE_BASE_URL = "https://cloud.langfuse.com"
# Cloudflare AI Gateway configuration (optional for local dev)
# Set CF_ACCOUNT_ID in .dev.vars or environment
# Create gateway at: https://dash.cloudflare.com/?to=/:account/ai/ai-gateway
CF_AI_GATEWAY_ID = "iofold-ai-gw"
# LangSmith Tracing (set LANGSMITH_API_KEY in .dev.vars)
LANGSMITH_TRACING_V2 = "true"
LANGSMITH_PROJECT = "iofold-development"

[[d1_databases]]
binding = "DB"
database_name = "iofold-staging-db"
database_id = "9eaff631-3152-432f-9d07-20de2ed8857f"

[[d1_databases]]
binding = "BENCHMARKS_DB"
database_name = "iofold-benchmarks"
database_id = "local"  # Local D1 uses "local" as ID

[[queues.producers]]
binding = "JOB_QUEUE"
queue = "iofold-jobs"

[[queues.consumers]]
queue = "iofold-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "iofold-jobs-dlq"

[[queues.producers]]
binding = "DEAD_LETTER_QUEUE"
queue = "iofold-jobs-dlq"

[[vectorize]]
binding = "VECTORIZE"
index_name = "system-prompts"

[ai]
binding = "AI"

[triggers]
crons = ["0 */6 * * *"]

# Sandbox Container for Python eval execution (local dev)
[[containers]]
class_name = "PythonSandbox"
image = "./Dockerfile"
instance_type = "lite"
max_instances = 2

[[durable_objects.bindings]]
name = "SANDBOX"
class_name = "PythonSandbox"

# Durable Object migrations
[[migrations]]
tag = "v1"
new_classes = ["Sandbox"]

# Add new SQLite-backed PythonSandbox for Containers
[[migrations]]
tag = "v2"
new_sqlite_classes = ["PythonSandbox"]
